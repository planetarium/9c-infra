name: Reset bridge service

on:
  workflow_dispatch:

jobs:
  reset-bridge-service:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up kubectl
      uses: azure/setup-kubectl@v1
      with:
        version: 'v1.29.0'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq

    - uses: actions-hub/kubectl@master
      env:
        KUBE_CONFIG: ${{ secrets.KUBECONFIG }}
      with:
        args: scale --replicas=0 statefulset/bridge-service -n heimdall
  
    - uses: actions-hub/kubectl@master
      env:
        KUBE_CONFIG: ${{ secrets.KUBECONFIG }}
      with:
        args: scale --replicas=0 statefulset/bridge-service-db -n heimdall
    
    - uses: actions-hub/kubectl@master
      env:
        KUBE_CONFIG: ${{ secrets.KUBECONFIG }}
      with:
        args: kubectl delete pvc/bridge-service-db-data-bridge-service-db-0 --namespace=heimdall
  
    - name: Reset
      id: reset
      run: |
        bash .github/scripts/reset-internal-heimdall-bridge-service.sh
      env:
        GITHUB_TOKEN: ${{ secrets.P_GITHUB_TOKEN }}

